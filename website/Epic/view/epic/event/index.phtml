<?
$title = 'Events';
$title = $this->_($title);
$this->headTitle($title, 'SET');
$items = $this->items;

$form = new Event\Form\EventUserForm();
$form
->setView($this)
->useSubFormGroup()
->setMethod('post')
->setAction($this->uri('/event/join/'))
->prepare();

$unjoinForm = clone $form;
$unjoinForm->setMethod('delete');


$eventSearchForm = $this->form ? $this->form : new Epic\Form\EventSearchForm();
$eventSearchForm->setView($this)
     ->setMethod('get')
     ->setAction($this->uri('/events/'))
     ->prepare();

$calendar = $this->calendar;
$week = $this->week;
$prevPath = $this->prevPath;
$nextPath = $this->nextPath;
$dayPath = $this->dayPath;
?>

<div class="container">
    <header class="event-header">
    <div class="row">
        <div class="span4">
            <h2><a href="<?=$this->uri('/events/')?>">Event</a></h2>
        </div><!--page main right end-->
        <div class="span8">
            <?=$this->widget('Epic', 'widgets/eventnav', $this->vars())?>
        </div><!--page main left end-->
    </div>
    </header>
</div>
<div class="container">
    <div class="page-bg">
        <div class="row">
            <div class="span4">
                <?=$this->widget('Epic', 'widgets/eventside', $this->vars())?>
            </div><!--page main right end-->
            <div class="span8">
                <div class="event-main">
                    <div id="event-calendar-wrap">
                    <table class="event-calendar table table-bordered table-condensed table-striped hide">
                        <thead>
                            <tr>
                                <td class="prev">
                                    <a href="<?=$this->uri($prevPath, array('start' => $calendar['prev']['startDay']))?>"><i class="icon-large icon-chevron-left highlight"></i></a>
                                </td>
                                <td class="switch" colspan="5"><a href="<?=$this->uri($prevPath, array('start' => $calendar['today']['startDay']))?>"><?=$calendar['monthName']?> <?=$calendar['yearName']?></a></td>
                                <td class="next">
                                    <a href="<?=$this->uri($prevPath, array('start' => $calendar['next']['startDay']))?>"><i class="icon-large icon-chevron-right highlight"></i></a>
                                </td>
                            </tr>
                            <tr>
                                <?foreach($calendar['weekNames'] as $weekname):?>
                                <th class="dow"><?=$weekname?></th>
                                <?endforeach;?>
                            </tr>
                        </thead>
                        <tbody>
                            <?foreach($calendar['days'] as $week):?>
                            <tr>
                                <?foreach($week as $day):?>
                                <th  title="<?=$day['datedb']?>" class="day <?=$day['isAdd'] ? "old" : ''?> <?=$day['datedb'] < $calendar['today']['datedb'] ? 'passed' : ''?>">
                                    <?if($day['datedb'] == $calendar['today']['datedb']):?>
                                    <span class="today"><?=$day['day']?></span>
                                    <?else:?>
                                    <?=$day['day']?>
                                    <?endif?>
                                   
                                </th>
                                <?endforeach;?>
                            </tr>
                            <tr>
                                <?foreach($week as $day):?>
                                <td title="<?=$day['datedb']?>" class="day <?=$day['isAdd'] ? "old" : ''?> <?=$day['datedb'] < $calendar['today']['datedb'] ? 'passed' : ''?>  <?=$day['datedb'] == $calendar['today']['datedb'] ? 'today' : ''?>">
                                    <?if (isset($day['Events'])):?>
                                        <?foreach ($day['Events'] as $event):?>
                                        <a href="<?=$this->uri('/event/' . $event['urlName'])?>" class="label label-event" title="<?=$event['title']?>"><?=$event['title']?></a>
                                        <?endforeach;?>
                                    <?endif;?>
                                </td>
                                <?endforeach;?>
                            </tr>
                            <?endforeach;?>
                        </tbody>
                    </table>
                    </div>

                    <script id="event-thumbnails" type="text/x-tmpl" data-url="<?=$this->uri('/data/event/', array('recommend' => 1,'rows' => 28))?>">
                    <div class="event-thumbnails">
                        <ul>
                            {% if(o.items.length > 0) { %}
                            {% for (var i=0, item; item=o.items[i]; i++) { %}
                                <li><a href="<?=$this->uri('/event/')?>{%=item.urlName%}">
                                {% if(item.File) { %}
                                    <img src="{%=eva.thumb(item.File.Thumb, 'c_fill,h_90,w_90')%}" alt="{%=item.title%}" />
                                {% }else{ %}
                                    <img src="{%=eva.s('/assets/module/epic/img/event-default.jpg')%}" alt="">
                                {% } %}
                                </a></li>
                            {% } %}
                            {% } %}
                        </ul>
                    </div> 
                    </script>

                    <div class="event-grid">
                        <header class="event-grid-header">
                        <small class="pull-right">Hot Cities: 
                            <a href="<?=$this->uri('/events/list/', array('city' => 'Paris','order' => 'timedesc'));?>">Paris</a>
                            <a href="<?=$this->uri('/events/list/', array('city' => 'London','order' => 'timedesc'));?>">London</a>
                            <a href="<?=$this->uri('/events/list/', array('city' => 'New York','order' => 'timedesc'));?>">New York</a>
                            <a href="<?=$this->uri('/events/list/', array('city' => 'Shanghai','order' => 'timedesc'));?>">Shanghai</a>
                        </small>
                        <div class="page-header border-header">
                            <h3>New Events </h3><a href="<?=$this->uri('/my/city/')?>" class="switch">[<span class="my-city">Switch City</span>]</a>
                        </div>
                        <ul class="event-new-nav nav nav-pills">
                            <li class="active"><a href="<?=$this->uri('/events/list/', array('order' => 'timedesc'));?>">All Cities</a> |</li>
                            <li><a href="<?=$this->uri('/events/list/', array('city' => 'mycity', 'order' => 'timedesc'));?>" class="my-city-url">My City</a> |</li>
                            <li><a href="<?=$this->uri('/events/list/', array('category' => 'Cocktail-Party','order' => 'timedesc'));?>">Cocktail Party</a> | </li>
                            <li><a href="<?=$this->uri('/events/list/', array('category' => 'Wine-Tasting','order' => 'timedesc'));?>">Wine Tasting</a> | </li>
                            <li><a href="<?=$this->uri('/events/list/', array('category' => 'Exhibitions','order' => 'timedesc'));?>">Exhibitions</a> | </li>
                            <li><a href="<?=$this->uri('/events/list/', array('category' => 'Cooking-Classes','order' => 'timedesc'));?>">Cooking Classes</a> | </li>
                            <li><a href="<?=$this->uri('/events/list/', array('category' => 'Opinions-sharing','order' => 'timedesc'));?>">Opinions Sharing</a> </li>
                        </ul>
                        </header>
                        <div class="event-new-wrap loaded">
                        <script id="event-new" type="text/x-tmpl" data-url="<?=$this->uri('/data/event/', array('order' => 'timedesc','rows' => 6))?>">
                        <div class="event-new grid-3columns">
                            {% if(o.items.length > 0) { %}
                            {% for (var i=0, item; item=o.items[i]; i++) { %}
                            <div class="event media">
                                <a class="pull-left" href="<?=$this->uri('/event/')?>{%=item.urlName%}">
                                    {% if(item.File) { %}
                                    <img  src="{%=eva.thumb(item.File.Thumb, 'c_fill,h_90,w_90')%}" width="90" height="90" class="media-object img-rounded"/>
                                    {% } else { %}
                                    <img  src="{%=eva.s('/assets/module/epic/img/event-default.jpg')%}" width="90" height="90" class="media-object img-rounded"/>
                                    {% } %}
                                </a>
                                <div class="media-body">
                                    <h4 class="media-heading"><a href="<?=$this->uri('/event/')?>{%=item.urlName%}">{%=item.title%}</a></h4>
                                    <div class="media">
                                        <p class="lowlight">City : {%=item.city%}.</p>
                                        <p class="lowlight">Start at : {%=item.startDay%}.</p>
                                        <p class="lowlight">{%=item.Count.memberCount%} members joined.</p>
                                    </div>
                                </div>
                            </div>
                            {% } %}
                            {% } %}
                        </div>
                        </script>
                        </div>
                        <div class="event-new-wrap"></div>
                        <div class="event-new-wrap"></div>
                        <div class="event-new-wrap"></div>
                        <div class="event-new-wrap"></div>
                        <div class="event-new-wrap"></div>
                        <div class="event-new-wrap"></div>
                    </div>

                    <div class="event-grid">
                        <header class="event-grid-header">
                        <div class="page-header border-header">
                            <h3>Feature Events</h3>
                        </div>
                        <ul class="event-feature-nav nav nav-pills">
                            <li class="active"><a href="<?=$this->uri('/events/list/', array('order' => 'memberdesc'));?>">All Cities</a> |</li>
                            <li><a href="<?=$this->uri('/events/list/', array('city' => 'mycity', 'order' => 'memberdesc'));?>" class="my-city-url">My City</a> |</li>
                            <li><a href="<?=$this->uri('/events/list/', array('category' => 'Cocktail-Party','order' => 'memberdesc'));?>">Cocktail Party</a> | </li>
                            <li><a href="<?=$this->uri('/events/list/', array('category' => 'Wine-Tasting','order' => 'memberdesc'));?>">Wine Tasting</a> | </li>
                            <li><a href="<?=$this->uri('/events/list/', array('category' => 'Exhibitions','order' => 'memberdesc'));?>">Exhibitions</a> | </li>
                            <li><a href="<?=$this->uri('/events/list/', array('category' => 'Cooking-Classes','order' => 'memberdesc'));?>">Cooking Classes</a> | </li>
                            <li><a href="<?=$this->uri('/events/list/', array('category' => 'Opinions-sharing','order' => 'memberdesc'));?>">Opinions Sharing</a> </li>
                        </ul>
                        </header>
                        
                        <div class="event-feature-wrap">
                        <script id="event-feature" type="text/x-tmpl" data-url="<?=$this->uri('/data/event/', array('order' => 'memberdesc','rows' => 6))?>">
                            <div class="event-feature grid-2columns">
                            {% if(o.items.length > 0) { %}
                            {% for (var i=0, item; item=o.items[i]; i++) { %}
                            <div class="event media">
                                <a class="pull-left" href="<?=$this->uri('/event/')?>{%=item.urlName%}">
                                    {% if(item.File) { %}
                                        <img  src="{%=eva.thumb(item.File.Thumb, 'c_fill,h_90,w_90')%}" width="90" height="90" class="media-object img-rounded"/>
                                    {% } else { %}
                                    <img  src="{%=eva.s('/assets/module/epic/img/event-default.jpg')%}" width="90" height="90" class="media-object img-rounded"/>
                                    {% } %}
                                </a>
                                <div class="media-body">
                                    <h4 class="media-heading"><a href="<?=$this->uri('/event/')?>{%=item.urlName%}">{%=item.title%}</a></h4>
                                    <div class="media">
                                        <p class="lowlight">City : {%=item.city%}.</p>
                                        <p class="lowlight">Start at : {%=item.startDay%}.</p>
                                        <p class="lowlight">{%=item.Count.memberCount%} members joined.</p>
                                    </div>
                                </div>
                            </div>
                            {% } %}
                            {% } %}
                        </div>
                        </script>
                        </div>
                        <div class="event-feature-wrap"></div>
                        <div class="event-feature-wrap"></div>
                        <div class="event-feature-wrap"></div>
                        <div class="event-feature-wrap"></div>
                        <div class="event-feature-wrap"></div>
                        <div class="event-feature-wrap"></div>
                    </div>



                </div><!--event main end-->
            </div><!--page main left end-->
        </div>
    </div><!-- page-bg end-->
</div><!--container end-->

<script>
eva.ready(function(){
        $(".nav-week a").on('click', function(){
                var calendar = $(".event-calendar");
                if(calendar.is(":visible")) {
                    calendar.fadeOut();
                    $(".event-thumbnails").fadeIn();
                } else {
                    calendar.fadeIn();
                    $(".event-thumbnails").fadeOut();
                }
                return false;
        });

        $("#event-calendar-wrap").on('click', '.prev a, .next a', function(){
                $("#event-calendar-wrap").load($(this).attr('href') + ' .event-calendar', function(){
                    $(".event-calendar").fadeIn();
                });
                return false;
        });

        $(".event-new-nav a").on('click', function(){
                var link = $(this);
                var index = link.parent().index();
                var wraps = $(".event-new-wrap");
                $(".event-new-nav li").removeClass('active');
                link.parent().addClass('active');
                if(wraps.eq(index).hasClass('loaded')) {
                        wraps.hide();
                        wraps.eq(index).show();
                } else {
                    wraps.eq(index).load($(this).attr('href') + ' .event-list', function(){
                        wraps.hide();
                        wraps.eq(index).addClass('loaded').show();
                    });
                }
                return false;
        });

        $(".event-feature-nav a").on('click', function(){
                var link = $(this);
                var index = link.parent().index();
                var wraps = $(".event-feature-wrap");
                $(".event-feature-nav li").removeClass('active');
                link.parent().addClass('active');
                if(wraps.eq(index).hasClass('loaded')) {
                        wraps.hide();
                        wraps.eq(index).show();
                } else {
                    wraps.eq(index).load($(this).attr('href') + ' .event-list', function(){
                        wraps.hide();
                        wraps.eq(index).addClass('loaded').show();
                    });
                }
                return false;
        });
});
</script>
