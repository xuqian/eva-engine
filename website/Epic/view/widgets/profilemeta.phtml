<?
$user = $this->user;
$viewAsGuest = $this->viewAsGuest;
$form = new Activity\Form\FollowForm();
$form
->setView($this)
->useSubFormGroup()
->setMethod('post')
->setAction($this->uri('/activity/follow'))
->prepare();

$unfollowForm = clone $form;
$unfollowForm->setMethod('delete');

$friendForm = new User\Form\FriendForm();
$friendForm
->setView($this)
->useSubFormGroup()
->setMethod('post')
->setAction($this->uri('/relationship/request/'))
->prepare();

$approveForm = clone $friendForm;
$approveForm->setAction($this->uri('/relationship/approve/'));

$refuseForm = clone $friendForm;
$refuseForm->setAction($this->uri('/relationship/refuse/'));

$unfriendForm = clone $friendForm;
$unfriendForm->setAction($this->uri('/relationship/unfriend/'));

$blockForm = clone $friendForm;
$blockForm->setAction($this->uri('/relationship/block/'));

$unblockForm = clone $friendForm;
$unblockForm->setAction($this->uri('/relationship/unblock/'));

function checkOauth($key, $user)
{
    if(!isset($user['Oauth'])) {
        return false;
    }
    $oauth = $user['Oauth'];
    foreach($oauth as $oauthinfo){
        if($key === $oauthinfo['adapterKey']) {
            return true;
        }
    }
    return false;
}

function personalRole($roles)
{
    if(!$roles){
        return false;
    }
    $allowRoles =  array (
        'CORPORATE_MEMBER',
        'CONNOISSEUR_MEMBER',
        'PROFESSIONAL_MEMBER',
    );
    foreach($roles as $role){
        if(in_array($role['roleKey'], $allowRoles)){
            return $role['roleName'];
        }
    }
}

function isPaidRole($roles)
{
    if(!$roles){
        return false;
    }
    foreach($roles as $role){
        if($role['roleKey'] == 'PAID_MEMBER'){
            return $role;
        }
    }
    return false;
}
?>
<div class="thumbnail profile-face">
    <a href="<?=$viewAsGuest ? $this->uri('/user/' . $user['userName']) : $this->uri('/account/profile/')?>">
        <img src="<?=$user['Avatar'] ? $this->thumb($user['Avatar']['Thumb'], array('h_175', 'w_175', 'c_fill')) :  $this->assets('/module/epic/img/default_avatar.png')?>" alt=""  width="175" height="175" />
    </a>
    <div class="caption">
        <a class="highlight highlight-large" href="<?=$this->uri('/my/friend/')?>"><?=$user['FriendsCount']['friendsCount']?></a> Friends
    </div>
</div>

<div class="profile-intro">
    <div class="profile-title">
        <h2><?=$user['userName']?></h2>
        <small class="profile-level"><?=$this->_(personalRole($user['Roles']))?>
            <?if(isPaidRole($user['Roles'])):?>
            <a href="<?=$this->uri('/account/membership/')?>" title="VIP User"><i class="icon-trophy"></i></a>
            <?endif?>
        </small>
        <?if($user['onlineStatus'] == 'online'):?>
        <span class="label label-success">Online</span> 
        <?else:?>
        <span class="label">Offline</span> 
        <?endif?>
    </div>

    <table class="table-condensed">
        <tbody>
            <tr>
                <td>City : 
                    <?if($user['Profile']['city']):?>
                    <?=$user['Profile']['city']?>
                    <?endif?>
                </td>
                <td colspan="2">Website : 
                    <?if($user['Profile']['site']):?>
                    <a href="<?=$user['Profile']['site']?>"><?=$user['Profile']['site']?></a>
                    <?endif?>
                </td>
            </tr>
            <tr>
                <td>Country : 
                    <?if($user['Profile']['country']):?>
                    <?=$this->locale('territory', $user['Profile']['country'])?>
                    <?endif?>
                </td>
                <td>Birthday : 
                    <?if($user['Profile']['birthday'] && $user['Profile']['birthday'] != '0000-00-00'):?>
                    <?=$user['Profile']['birthday']?>
                    <?else:?>
                    Secret
                    <?endif?>
                </td>
                <td>Events : <a href="<?=$viewAsGuest ? $this->uri('/user/' . $user['userName'] . '/events/') : $this->uri('/my/event/')?>"><?=$user['EventCount']['eventCount']?></a> Times</td>
            </tr>
            <?if($user['Tags']):?>
            <tr>
                <td colspan="3">Tags : 
                    <?foreach($user['Tags'] as $tag):?>
                    <a href="<?=$this->uri('/user/list/?tag=' . $tag['tagName']);?>" class="label"><?=$tag['tagName']?></a>
                    <?endforeach?>
                </td>
            </tr>
            <?endif?>
            <?if(0 && $user['Profile']['bio']):?>
            <tr>
                <td colspan="3">Bio : 
                    <?=$user['Profile']['bio']?>
                </td>
            </tr>
            <?endif?>
            <tr>
                <td colspan="3" class="social">
                    Social Networking : 
                    <a href="<?=$this->uri('/oauth/', array('r' => $this->serverUrl() . '/login/oauth/', 'service' => 'facebook',))?>"><span class="lsf symbol facebook <?=checkOauth('facebook', $user) ? 'highlight' : ''?>">facebook</span></a>
                    <a href="<?=$this->uri('/oauth/', array('r' => $this->serverUrl() . '/login/oauth/', 'service' => 'twitter', 'version' => 1))?>"><span class="lsf symbol twitter <?=checkOauth('twitter', $user) ? 'highlight' : ''?>">twitter</span></a>
                    <a href="<?=$this->uri('/oauth/', array('r' => $this->serverUrl() . '/login/oauth/', 'service' => 'flickr', 'version' => 1))?>"><span class="lsf symbol flickr <?=checkOauth('flickr', $user) ? 'highlight' : ''?>">flickr</span></a>
                </td>
            </tr>
            <tr>
                <td colspan="3" class="form-buttons">
                    <?if($viewAsGuest):?>
                    <form <?=$this->formAttr($form)?> class="follow-form pull-left">
                        <?=$form->restful();?>
                        <?=$form->helper('user_id', array('class' => '', 'value' => $this->user['id']))?>
                        <?=$form->helper('follower_id', array('class' => ''))?>
                        <?=$this->callback()?>
                        <button class="btn btn-brown btn-mini"><i class="icon-mini icon-plus"></i> Follow</button>
                    </form>
                    <form <?=$this->formAttr($unfollowForm)?> class="unfollow-form hide follow-check pull-left" data-url="<?=$this->uri('/data/isfollower/')?>">
                        <?=$unfollowForm->restful();?>
                        <?=$unfollowForm->helper('user_id', array('class' => '', 'value' => $this->user['id']))?>
                        <?=$unfollowForm->helper('follower_id', array('class' => ''))?>
                        <?=$this->callback()?>
                        <button class="btn btn-brown btn-mini" href="<?=$this->uri('/activity/follow/')?>"><i class="icon-mini icon-minus"></i> Unfollow</button>
                    </form>
                    <form <?=$this->formAttr($friendForm)?> class="friend-form pull-left friend-check relationship-form hide showon-removed showon-refused"  data-url="<?=$this->uri('/data/isfriend/')?>">
                        <?=$friendForm->restful();?>
                        <?=$friendForm->helper('friend_id', array('class' => '', 'value' => $this->user['id']))?>
                        <?=$this->callback()?>
                        <button class="btn btn-orange btn-mini"><i class="icon-mini icon-plus"></i> Add Friend</button>
                    </form>
                    <form <?=$this->formAttr($approveForm)?> class="approve-form pull-left relationship-form hide showon-pending">
                        <?=$approveForm->restful();?>
                        <?=$approveForm->helper('friend_id', array('class' => '', 'value' => $this->user['id']))?>
                        <?=$this->callback()?>
                        <button class="btn btn-orange btn-mini"><i class="icon-mini icon-ok"></i> Approve Request</button>
                    </form>
                    <form <?=$this->formAttr($refuseForm)?> class="refuse-form pull-left relationship-form hide showon-pending">
                        <?=$refuseForm->restful();?>
                        <?=$refuseForm->helper('friend_id', array('class' => '', 'value' => $this->user['id']))?>
                        <?=$this->callback()?>
                        <button class="btn btn-orange btn-mini"><i class="icon-mini icon-remove"></i> Refuse</button>
                    </form>
                    <form <?=$this->formAttr($unfriendForm)?> class="unfriend-form pull-left relationship-form hide showon-approved">
                        <?=$unfriendForm->restful();?>
                        <?=$unfriendForm->helper('friend_id', array('class' => '', 'value' => $this->user['id']))?>
                        <?=$this->callback()?>
                        <button class="btn btn-orange btn-mini" data-text="Cancel Request"><i class="icon-mini icon-remove"></i> Unfriend</button>
                    </form>
                    <form <?=$this->formAttr($blockForm)?> class="block-form pull-left relationship-form showon-removed hide showon-refused">
                        <?=$blockForm->restful();?>
                        <?=$blockForm->helper('friend_id', array('class' => '', 'value' => $this->user['id']))?>
                        <?=$this->callback()?>
                        <button class="btn btn-gray btn-mini"><i class="icon-mini icon-remove"></i> Block</button>
                    </form>
                    <form <?=$this->formAttr($unblockForm)?> class="unblock-form pull-left relationship-form hide  showon-blocked">
                        <?=$unblockForm->restful();?>
                        <?=$unblockForm->helper('friend_id', array('class' => '', 'value' => $this->user['id']))?>
                        <?=$this->callback()?>
                        <button class="btn btn-gray btn-mini"><i class="icon-mini icon-undo"></i> Unblock</button>
                    </form>
                    <a class="btn btn-gray btn-mini" href="<?=$this->uri('/messages/send/' . $this->user['userName'])?>"><i class="icon-mini icon-envelope-alt"></i> Send Message</a>
                    <?else:?>
                    <a class="btn btn-gray btn-mini" href="<?=$this->uri('/user/' . $this->user['userName'])?>"><i class="icon-mini icon-eye-open"></i> View As Guest</a>
                    <?endif?>
                </td>
            </tr>

        </tbody>
    </table>
</div><!--profile-intro end-->
